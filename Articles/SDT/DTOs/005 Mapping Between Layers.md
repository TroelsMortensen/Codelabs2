# Mapping Between Layers

Now that we have DTOs, we need to convert between domain entities and DTOs. This conversion is called **mapping**, and it happens in the **Business Logic layer**.

## Where Mapping Happens

The mapping between entities and DTOs should happen in the **Business Logic layer** (service layer):

```mermaid
graph LR
    A[Persistence Layer] -->|Returns Entities| B[Business Logic Layer]
    B -->|Converts to DTOs| C[Presentation Layer]
    
    style A fill:#27F58B,color:#000000
    style B fill:#2795F5,color:#000000
    style C fill:#F5BB27,color:#000000
```


- **Persistence Layer** returns domain entities
- **Business Logic Layer** converts entities to DTOs
- **Presentation Layer** receives DTOs

## Converting Entity to DTO

The most common mapping is **Entity → DTO**. This happens when the business logic layer needs to return data to the presentation layer.

### Simple Mapping: Planet

For a simple entity like `Planet`, the mapping is straightforward:

```java
public class PlanetService 
{
    private PlanetDataManager planetDataManager;
    
    public PlanetDTO getPlanet(int id) 
    {
        Planet planet = planetDataManager.findById(id);
        if (planet == null) 
        {
            return null;
        }
        
        // Convert entity to DTO
        return new PlanetDTO(
            planet.getId(),
            planet.getName(),
            planet.getClimateDescription(),
            planet.getDistanceFromStarAU(),
            planet.hasAtmosphere(),
            planet.hasLife()
        );
    }
    
    public ArrayList<PlanetDTO> getAllPlanets() 
    {
        ArrayList<Planet> planets = planetDataManager.getAll();
        ArrayList<PlanetDTO> dtos = new ArrayList<>();
        
        for (Planet planet : planets) 
        {
            dtos.add(new PlanetDTO(
                planet.getId(),
                planet.getName(),
                planet.getClimateDescription(),
                planet.getDistanceFromStarAU(),
                planet.hasAtmosphere(),
                planet.hasLife()
            ));
        }
        
        return dtos;
    }
}
```

### Mapping with Resolved Foreign Keys: Explorer

For entities with foreign keys, you need to resolve them:

```java
public class ExplorerService 
{
    private ExplorerDataManager explorerDataManager;
    private SpacecraftDataManager spacecraftDataManager;
    
    public ExplorerDTO getExplorer(int id) 
    {
        Explorer explorer = explorerDataManager.findById(id);
        if (explorer == null) 
        {
            return null;
        }
        
        // Resolve foreign key
        Spacecraft spacecraft = spacecraftDataManager.findById(explorer.getSpacecraftId());
        String spacecraftName = (spacecraft != null) ? spacecraft.getName() : "Unknown";
        
        // Convert entity to DTO with resolved value
        return new ExplorerDTO(
            explorer.getId(),
            explorer.getName(),
            spacecraftName  // Resolved, not the ID
        );
    }
}
```


## Converting DTO to Entity

Sometimes you need to convert **DTO → Entity**, typically when creating new entities from user input.

Here, the data flows from the presentation layer to the business logic layer, i.e. opposite of the above examples.\
In this type of case, I prefer to suffix my DTO with "Request", instead of "DTO". Examples: `CreatePlanetRequest`, `UpdatePlanetRequest`, `DeletePlanetRequest`. The user is requesting something of the system, indicated by the DTO name and data.

```java
public class PlanetService 
{
    private PlanetDataManager planetDataManager;
    
    public void createPlanet(PlanetRequest request) 
    {
        // Convert DTO to entity
        Planet planet = new Planet(
            request.getName(),
            request.getClimateDescription(),
            request.getDistanceFromStarAU(),
            request.hasAtmosphere(),
            request.hasLife()
        );
        
        // Save entity
        planetDataManager.add(planet);
        planetDataManager.save();
    }
}
```

**Note:** When creating entities, the DTO typically doesn't have an ID yet (it's generated by the data manager).

## Helper Methods

You can extract mapping logic into helper methods for reusability.

```java
public class PlanetService 
{
    private PlanetDataManager planetDataManager;
    
    // Helper method: Entity → DTO
    private PlanetDTO toDTO(Planet planet) 
    {
        return new PlanetDTO(
            planet.getId(),
            planet.getName(),
            planet.getClimateDescription(),
            planet.getDistanceFromStarAU(),
            planet.hasAtmosphere(),
            planet.hasLife()
        );
    }
    
    // Helper method: DTO → Entity (for creation)
    private Planet fromDTO(PlanetDTO dto) 
    {
        return new Planet(
            dto.getName(),
            dto.getClimateDescription(),
            dto.getDistanceFromStarAU(),
            dto.hasAtmosphere(),
            dto.hasLife()
        );
    }
    
    public PlanetDTO getPlanet(int id) 
    {
        Planet planet = planetDataManager.findById(id);
        return (planet != null) ? toDTO(planet) : null;
    }
    
    public ArrayList<PlanetDTO> getAllPlanets() 
    {
        ArrayList<Planet> planets = planetDataManager.getAll();
        ArrayList<PlanetDTO> dtos = new ArrayList<>();
        
        for (Planet planet : planets) 
        {
            dtos.add(toDTO(planet));
        }
        
        return dtos;
    }
    
    public void createPlanet(PlanetDTO dto) 
    {
        Planet planet = fromDTO(dto);
        planetDataManager.add(planet);
        planetDataManager.save();
    }
}
```

## Separate Mapper Classes

For complex mappings, or if the same mapping is used in multiple places, you might create separate mapper classes:

```java
public class PlanetMapper 
{
    public static PlanetDTO toDTO(Planet planet) 
    {
        return new PlanetDTO(
            planet.getId(),
            planet.getName(),
            planet.getClimateDescription(),
            planet.getDistanceFromStarAU(),
            planet.hasAtmosphere(),
            planet.hasLife()
        );
    }
    
    public static Planet fromDTO(PlanetDTO dto) 
    {
        return new Planet(
            dto.getName(),
            dto.getClimateDescription(),
            dto.getDistanceFromStarAU(),
            dto.hasAtmosphere(),
            dto.hasLife()
        );
    }
}
```

Then use it in the service:

```java
public class PlanetService 
{
    private PlanetDataManager planetDataManager;
    
    public PlanetDTO getPlanet(int id) 
    {
        Planet planet = planetDataManager.findById(id);
        return (planet != null) ? PlanetMapper.toDTO(planet) : null;
    }
}
```


## Summary

- Mapping happens in the **Business Logic layer**
- **Entity → DTO**: Convert when returning data to presentation layer
- **DTO → Entity**: Convert when creating entities from user input
- **Resolve foreign keys** to names/values in DTOs
- Use **helper methods** or **separate mapper classes** for reusability
- Keep mapping logic **simple and clear**


